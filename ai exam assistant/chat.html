<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exmora - Research Workspace</title>

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Base Styles & Icons -->
    <link rel="stylesheet" href="./frontend/styles/main.css?v=6" />
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- External Libs -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <!-- Auth -->
    <script src="./frontend/scripts/auth.js"></script>
    <script>
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }
    </script>

    <style>
        /* Premium Workspace UI Overrides */
        body {
            background-color: #030712;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        /* Ambient Background Context */
        .workspace-bg {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0; pointer-events: none;
            background: radial-gradient(circle at top right, rgba(168, 85, 247, 0.08), transparent 45%),
                        radial-gradient(circle at bottom left, rgba(99, 102, 241, 0.05), transparent 45%);
        }
        .workspace-noise {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1; pointer-events: none; opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
            z-index: 10;
        }

        /* ==== LEFT SIDEBAR ==== */
        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.08);
            display: flex; flex-direction: column;
            padding: 24px 16px;
            z-index: 20;
        }

        .sidebar-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 32px; padding: 0 8px;
        }
        .logo-icon {
            width: 32px; height: 32px; background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4); color: white;
        }
        .logo-text { font-size: 1.25rem; font-weight: 700; color: #fff; letter-spacing: -0.5px; }

        .new-chat-btn {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff; padding: 12px 16px; border-radius: 12px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 0.95rem; margin-bottom: 24px;
        }
        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.1); border-color: rgba(168, 85, 247, 0.4);
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.2);
        }

        .history-list {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 4px;
        }
        /* Custom scrollbar for history */
        .history-list::-webkit-scrollbar { width: 4px; }
        .history-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        .history-item {
            padding: 12px; border-radius: 10px; background: transparent; border: 1px solid transparent;
            cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 8px; text-align: left;
        }
        .history-item:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(255, 255, 255, 0.08); transform: translateX(2px); }
        .history-item.active { background: rgba(168, 85, 247, 0.1); border-color: rgba(168, 85, 247, 0.3); }
        
        .history-item-top { display: flex; justify-content: space-between; align-items: center; }
        .history-title { font-size: 0.9rem; color: #e2e8f0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-pin { color: #64748b; opacity: 0; transition: opacity 0.2s; }
        .history-item:hover .history-pin { opacity: 0.5; }
        .history-item.pinned .history-pin { opacity: 1; color: #a855f7; }

        .history-chip {
            display: inline-flex; align-items: center; gap: 4px; font-size: 0.7rem; color: #94a3b8;
            background: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 6px; width: fit-content;
        }

        .user-profile {
            margin-top: auto; padding: 12px; display: flex; align-items: center; gap: 12px;
            background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
        }
        .icon-user {
            width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #94a3b8;
        }
        .user-email { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; color: #e2e8f0; }
        .logout-btn { background: none; border: none; color: #94a3b8; cursor: pointer; transition: color 0.2s; }
        .logout-btn:hover { color: #ef4444; }

        /* ==== CENTER MAIN CONTENT ==== */
        .main-content {
            flex: 1; display: flex; flex-direction: column; position: relative;
        }
        .glass-header {
            height: 72px; padding: 0 32px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: none; background: rgba(3, 7, 18, 0.5); backdrop-filter: blur(10px); z-index: 10;
        }
        .header-title { font-size: 0.9rem; color: #94a3b8; font-weight: 500; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;}
        .icon-btn { background: none; border: none; color: #94a3b8; cursor: pointer; transition: color 0.2s; padding: 6px; border-radius: 6px;}
        .icon-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }

        .chat-feed {
            flex: 1; overflow-y: auto; padding: 0 32px; display: flex; flex-direction: column; scroll-behavior: smooth;
            width: 100%; 
            /* Using padding-bottom instead of margin to prevent edge cutoffs without lines */
            padding-bottom: 64px; 
            transition: padding 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Premium Empty State */
        .welcome-screen {
            margin: auto; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; max-width: 520px; animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .glow-icon-container {
            width: 72px; height: 72px; background: rgba(168, 85, 247, 0.1); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin-bottom: 24px;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.2); border: 1px solid rgba(168, 85, 247, 0.3);
            position: relative;
        }
        .glow-icon-container::after {
            content: ''; position: absolute; inset: -10px; border-radius: 50%; border: 1px solid rgba(168, 85, 247, 0.2); animation: pulse-ring 2s infinite; opacity: 0;
        }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }
        .animated-sparkle { color: #c084fc; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 8px #c084fc); } }
        
        .welcome-text h1 { font-size: 2.2rem; font-weight: 700; margin-bottom: 12px; background: linear-gradient(180deg, #fff 0%, #cbd5e1 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px;}
        .welcome-text p { color: #94a3b8; font-size: 1.05rem; line-height: 1.6; margin-bottom: 32px; font-weight: 400; }

        .empty-suggestions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-top: auto; }
        .suggestion-chip {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.08); color: #e2e8f0; padding: 10px 16px; border-radius: 20px; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .suggestion-chip:hover {
            background: rgba(255,255,255,0.06); border-color: rgba(168, 85, 247, 0.4); transform: translateY(-2px); box-shadow: 0 8px 16px rgba(168, 85, 247, 0.15);
        }

        /* Premium Chat Bubbles - True Conversational System */
        .message { 
            width: 100%; margin: 0 auto; max-width: 850px; 
            display: flex; flex-direction: column;
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
            line-height: 1.6;
        }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* User Bubbles */
        .message.user { 
            align-items: flex-end; 
        }
        .message.user .msg-content {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
            border: 1px solid rgba(168, 85, 247, 0.2);
            color: #f8fafc; padding: 14px 20px; 
            border-radius: 20px 20px 4px 20px; 
            max-width: 80%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .message.user .msg-content:hover {
            transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        /* AI Bubbles */
        .message.bot { 
            align-items: flex-start;
        }
        .message.bot .msg-content {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255,0.08);
            border-left: 2px solid rgba(168, 85, 247, 0.8); /* Soft glow accent on left edge */
            color: #cbd5e1; padding: 18px 24px; 
            border-radius: 4px 20px 20px 20px; 
            max-width: 90%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2), inset 12px 0 24px rgba(168, 85, 247, 0.05);
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .message.bot .msg-content:hover {
            transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3), inset 12px 0 24px rgba(168, 85, 247, 0.1);
        }

        .agent-header, .user-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 6px; padding: 0 4px;
        }
        .agent-avatar {
            width: 24px; height: 24px; border-radius: 6px; 
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.4);
        }
        .agent-name, .user-name {
            font-size: 0.9rem; font-weight: 600; color: #f8fafc; display: flex; align-items: center; gap: 8px;
        }
        .live-timestamp {
            font-size: 0.75rem; color: #64748b; margin-left: auto; font-weight: 500;
        }
        
        .ai-status-indicator {
            display: inline-flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: 500;
            background: rgba(168, 85, 247, 0.1); color: #c084fc; padding: 2px 8px; border-radius: 12px;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #c084fc;
        }
        .status-dot.pulsing {
            animation: statusPulse 1.5s infinite;
        }
        @keyframes statusPulse { 0% { box-shadow: 0 0 0 0 rgba(192, 132, 252, 0.7); } 70% { box-shadow: 0 0 0 4px rgba(192, 132, 252, 0); } 100% { box-shadow: 0 0 0 0 rgba(192, 132, 252, 0); } }

        /* Content Structure Styling with Educational Enhancements */
        .msg-content { display: flex; flex-direction: column; gap: 4px; font-size: 0.95rem; }
        .msg-content h1, .msg-content h2, .msg-content h3 { margin-top: 1.5rem; margin-bottom: 0.75rem; color: #fff; font-weight: 600; }
        .msg-content h3 { font-size: 0.85rem; letter-spacing: 0.5px; text-transform: uppercase; color: #c084fc; border-bottom: 1px solid rgba(255,255,255,0.06); padding-bottom: 6px; }
        .msg-content p { margin: 0 0 16px 0; line-height: 1.7; }
        .msg-content ul, .msg-content ol { padding-left: 20px; margin: 0 0 16px 0; }
        .msg-content li { margin-bottom: 8px; padding-left: 4px; }
        .msg-content li::marker { color: #a855f7; }
        .msg-content strong { color: #fff; font-weight: 600; }
        
        /* Educational Callouts */
        .key-concept { background: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1; padding: 12px 16px; border-radius: 4px 8px 8px 4px; margin-bottom: 16px; }
        .exam-tip { background: rgba(234, 179, 8, 0.1); border-left: 3px solid #eab308; padding: 12px 16px; border-radius: 4px 8px 8px 4px; margin-bottom: 16px; }
        .common-mistake { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 12px 16px; border-radius: 4px 8px 8px 4px; margin-bottom: 16px; }
        
        .msg-actions {
            display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; margin-left: 4px;
            opacity: 0; transition: opacity 0.3s ease; transform: translateY(5px); pointer-events: none;
        }
        .message.bot:hover .msg-actions { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .msg-action-btn {
            background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px;
            border-radius: 12px; color: #94a3b8; font-size: 0.75rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); backdrop-filter: blur(8px);
        }
        .msg-action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(168, 85, 247, 0.4); transform: translateY(-1px); }

        /* Floating Composer (Input Area) */
        .input-area { 
            padding: 0 32px 40px; position: relative; z-index: 20; 
            width: 100%; max-width: 850px; margin: 0 auto;
            transition: padding 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .input-container {
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 16px; padding: 12px 16px;
            box-shadow: 0 -12px 24px rgba(3,7,18,0.8), 0 12px 24px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; gap: 8px;
        }
        .input-container:focus-within {
            border-color: rgba(168, 85, 247, 0.5); box-shadow: 0 -12px 24px rgba(3,7,18,0.8), 0 12px 24px rgba(0,0,0,0.6), 0 0 24px rgba(168, 85, 247, 0.15);
        }
        .composer-input {
            background: transparent; border: none; color: #fff; font-size: 1rem; font-family: inherit; line-height: 1.5;
            resize: none; outline: none; width: 100%; max-height: 250px; padding: 0;
        }
        .composer-input::placeholder { color: #64748b; }
        
        .input-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
        .input-tools { display: flex; align-items: center; gap: 8px; }
        .tool-btn { 
            background: none; border: 1px solid transparent; color: #94a3b8; cursor: pointer; padding: 8px; 
            border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.06); color: #e2e8f0; }
        
        /* Updated Send Button */
        .send-btn {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; font-size: 0.95rem; font-family: inherit;
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.4);
        }
        .send-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(168, 85, 247, 0.6); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }

        /* ==== RIGHT INSIGHT PANEL ==== */
        .insight-panel {
            width: 300px; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; z-index: 20;
        }
        .insight-header {
            height: 72px; padding: 0 24px; display: flex; align-items: center; gap: 8px;
            border-bottom: none; font-weight: 600; font-size: 0.95rem; color: #f8fafc;
        }
        .insight-content {
            flex: 1; overflow-y: auto; overflow-x: hidden; padding: 24px; display: flex; flex-direction: column; gap: 32px; white-space: normal;
        }
        .insight-content::-webkit-scrollbar { width: 4px; }
        .insight-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        .vis-card {
            background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 18px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
        }
        .vis-title { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; font-weight: 600; }
        .vis-metric { font-size: 2.2rem; font-weight: 700; color: #fff; margin-bottom: 12px; display: flex; align-items: baseline; gap: 4px; }
        .vis-metric span { font-size: 1rem; color: #a855f7; font-weight: 600; }
        .vis-bar-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .vis-bar-fill { height: 100%; width: 92%; background: linear-gradient(90deg, #6366f1, #a855f7); border-radius: 3px; transition: width 1s ease; }

        .insight-section h4 { font-size: 0.75rem; color: #94a3b8; font-weight: 600; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;}
        .insight-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .i-chip { 
            font-size: 0.8rem; color: #c084fc; background: rgba(168, 85, 247, 0.1); 
            border: 1px solid rgba(168, 85, 247, 0.2); padding: 6px 12px; border-radius: 8px; font-weight: 500;
        }

        .quick-tools { display: flex; flex-direction: column; gap: 8px; }
        .q-tool-btn {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            color: #e2e8f0; padding: 12px 16px; border-radius: 10px; font-size: 0.85rem; font-family: inherit;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500;
        }
        .q-tool-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(168, 85, 247, 0.3); transform: translateX(2px); }
        .q-tool-btn i { color: #a855f7; }

        /* Workspace Collapse Transitions */
        .sidebar, .insight-panel {
            transition: width 0.25s cubic-bezier(0.16, 1, 0.3, 1), padding 0.25s ease;
            white-space: nowrap; overflow: hidden;
        }
        
        .toggle-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: #94a3b8; cursor: pointer; border-radius: 8px; padding: 4px; 
            display: flex; align-items: center; justify-content: center; transition: all 0.2s; 
        }
        .toggle-btn:hover { 
            background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(168,85,247,0.4); 
            box-shadow: 0 0 12px rgba(168,85,247,0.2); 
        }

        /* App Floating Toggles */
        .app-floating-toggle {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 32px; height: 32px; border-radius: 50%; padding: 0;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px);
            z-index: 100; border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transition: left 0.25s cubic-bezier(0.16, 1, 0.3, 1), right 0.25s cubic-bezier(0.16, 1, 0.3, 1), background 0.2s, border-color 0.2s;
        }
        .app-left-toggle { left: 264px; }
        .app-left-toggle.collapsed { left: 56px; }
        .app-left-toggle i { transition: transform 0.25s; }
        .app-left-toggle.collapsed i { transform: rotate(180deg); }

        .app-right-toggle { right: 284px; }
        .app-right-toggle.collapsed { right: 56px; }
        .app-right-toggle i { transition: transform 0.25s; }
        .app-right-toggle.collapsed i { transform: rotate(-180deg); }
        
        /* Sidebar Collapsed */
        .sidebar.collapsed { width: 72px; padding: 24px 8px; align-items: center; }
        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .new-chat-btn span,
        .sidebar.collapsed .user-email,
        .sidebar.collapsed .history-content { display: none !important; }
        .sidebar.collapsed .sidebar-header { justify-content: center; padding: 0; width: 100%; margin-bottom: 24px; }
        .sidebar.collapsed .new-chat-btn { padding: 12px; justify-content: center; border-radius: 50%; width: 42px; height: 42px; }
        .sidebar.collapsed .history-icon-only { display: flex !important; margin: auto; }
        .sidebar.collapsed .user-profile { flex-direction: column; padding: 12px 0; gap: 16px; border: none; background: transparent; }
        
        /* Insight Panel Collapsed */
        .insight-panel.collapsed { width: 72px; padding: 0; align-items: center; }
        .insight-panel.collapsed .insight-title,
        .insight-panel.collapsed .vis-card,
        .insight-panel.collapsed .insight-section h4,
        .insight-panel.collapsed .shortcut-item,
        .insight-panel.collapsed .changelog-container,
        .insight-panel.collapsed .insight-chips { display: none; }
        .insight-panel.collapsed .insight-header { padding: 24px 0 0 0; justify-content: center; border-bottom: none; width: 100%; flex-direction: column; gap: 16px; }
        .insight-panel.collapsed .insight-content { padding: 16px 8px; align-items: center; }
        .insight-panel.collapsed .q-tool-btn { padding: 12px; justify-content: center; margin-bottom: 8px; width: 42px; height: 42px; border-radius: 50%; }
        .insight-panel.collapsed .q-tool-btn span { display: none; }
        .insight-panel.collapsed .q-tool-btn i { margin: 0; }
        .insight-panel.collapsed .insight-section-toggle i { display: none; }

        /* Productivity Hub Styles */
        .shortcut-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #cbd5e1; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04); cursor: help; }
        .shortcut-item:last-child { border-bottom: none; }
        .key-group { display: flex; gap: 4px; }
        .key-badge { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: #fff; font-family: monospace; font-weight: 600; }
        
        .version-badge { background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; color: #fff; font-weight: 700; letter-spacing: 0.5px; }
        .changelog-item { position: relative; padding: 8px 12px; border-left: 2px solid rgba(168, 85, 247, 0.4); margin-bottom: 8px; border-radius: 8px; transition: background 0.2s; cursor: pointer; }
        .changelog-item:hover { background: rgba(255,255,255,0.04); border-left-color: #c084fc; }
        .changelog-item:last-child { margin-bottom: 0; }
        
        .changelog-desc {
            font-size: 0.75rem; color: #94a3b8; line-height: 1.4; margin: 0;
            display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;
        }
        
        @media (max-width: 1024px) { 
            .insight-panel { display: none !important; }
            .app-right-toggle { display: none !important; }
        }
        @media (max-width: 768px) { 
            .sidebar { 
                position: fixed; left: -100%; top: 0; bottom: 0; 
                z-index: 200; width: 280px !important; display: flex !important; 
                transition: left 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            } 
            .sidebar.open { left: 0; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
            .insight-panel { display: none !important; }
            .app-left-toggle, .app-right-toggle { display: none !important; }
            .glass-header { padding: 0 20px; height: 60px; } 
            #menu-toggle { display: block !important; } 
            .chat-feed { padding-left: 16px; padding-right: 16px; } 
            .input-area { padding-left: 16px; padding-right: 16px; padding-bottom: 24px; max-width: 100%;}
            .message { max-width: 100%; }
        }

        /* Productivity Features: Streaming & Focus */
        .streaming-cursor {
            display: inline-block; width: 8px; height: 16px; background: #a855f7;
            margin-left: 4px; vertical-align: middle;
            animation: blink 1s step-end infinite;
            box-shadow: 0 0 8px #a855f7;
            border-radius: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        body.focus-mode .sidebar, body.focus-mode .insight-panel { display: none !important; width: 0 !important; }
        body.focus-mode .app-floating-toggle { opacity: 0 !important; pointer-events: none; }
    </style>
</head>

<body>
    <!-- Background Vibe -->
    <div class="workspace-bg"></div>
    <div class="workspace-noise"></div>

    <div class="app-container">
        <!-- ==== LEFT SIDEBAR (Project View) ==== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-content" style="display:flex; align-items:center; gap:12px;">
                    <div class="logo-icon" title="Exmora"><i data-lucide="sparkles" size="18"></i></div>
                    <div class="logo-text">Exmora</div>
                </div>
            </div>
            
            <button id="new-chat-btn" class="new-chat-btn" title="New Session">
                <i data-lucide="plus" size="18"></i> <span>New Session</span>
            </button>

            <div class="history-list" id="response-box">
                <!-- Example styled history items (main.js populates this) -->
                <div class="history-item active" title="Neural Networks Analysis">
                    <div class="history-icon-only" style="display:none; align-items:center; justify-content:center; color:#94a3b8;"><i data-lucide="message-square" size="18"></i></div>
                    <div class="history-content">
                        <div class="history-item-top">
                            <span class="history-title">Neural Networks Analysis</span>
                            <i data-lucide="pin" size="14" class="history-pin" style="opacity: 1; color: #a855f7;"></i>
                        </div>
                        <div class="history-chip"><i data-lucide="file-text" size="10"></i> chapter_4.pdf</div>
                    </div>
                </div>
            </div>

            <div class="user-profile" id="user-profile-btn">
                <div class="icon-user"><i data-lucide="user" size="18"></i></div>
                <div id="user-email" class="user-email">user@example.com</div>
                <button id="logout-btn" class="logout-btn" title="Logout">
                    <i data-lucide="log-out" size="18"></i>
                </button>
            </div>
        </aside>

        <button id="sidebar-collapse-btn" class="toggle-btn app-floating-toggle app-left-toggle" title="Collapse Sidebar (⌘B)">
            <i data-lucide="chevron-left" size="16"></i>
        </button>

        <!-- ==== MAIN CHAT WORKSPACE ==== -->
        <main class="main-content">
            <!-- Header -->
            <header class="glass-header">
                <div class="header-title"><i data-lucide="layout-dashboard" size="16"></i> Workspace / active_session</div>
                
                <div class="header-actions" style="display:flex; gap:12px;">
                    <button id="export-btn" class="icon-btn" title="Export Logs">
                        <i data-lucide="download" size="18"></i>
                    </button>
                    <!-- Mobile Toggle -->
                    <button id="menu-toggle" class="icon-btn" style="display:none;" title="Toggle Sidebar">
                        <i data-lucide="menu" size="18"></i>
                    </button>
                </div>
            </header>

            <!-- Chat Feed (Output Console) -->
            <div class="chat-feed" id="chat-history">
                <div class="welcome-screen">
                    <div class="glow-icon-container">
                        <i data-lucide="sparkles" size="32" class="animated-sparkle"></i>
                    </div>
                    <div class="welcome-text">
                        <h1>Start researching</h1>
                        <p id="welcome-instruction">Upload a document, attach a file, or enter a complex query to initialize an intelligent session.</p>
                    </div>
                    <div class="empty-suggestions">
                        <button class="suggestion-chip" onclick="document.getElementById('query-input').value = 'Extract insights from local PDF...';"><i data-lucide="file-text" size="16"></i> Extract insights from PDF</button>
                        <button class="suggestion-chip" onclick="document.getElementById('query-input').value = 'Explain the attention mechanism in Transformers';"><i data-lucide="zap" size="16"></i> Explain complex concepts</button>
                    </div>
                </div>
            </div>

        <!-- Floating Composer (Input Area) -->
            <div class="input-area">
                <div class="input-container">
                    <textarea id="query-input" class="composer-input" placeholder="Ask a question... (Press ⌘K for commands, ⌘↵ to run)" rows="1" disabled></textarea>
                    
                    <div class="input-actions">
                        <div class="input-tools">
                            <!-- File Upload -->
                            <input type="file" id="file-input" style="display:none;" accept=".pdf" multiple />
                            <button id="upload-trigger" class="tool-btn" title="Upload Source">
                                <i data-lucide="paperclip" size="18"></i>
                            </button>
                            <!-- Voice Input -->
                            <button id="voice-trigger" class="tool-btn hidden" title="Voice Input">
                                <i data-lucide="mic" size="18"></i>
                            </button>
                            <!-- Hidden tools for JS dependencies -->
                            <button id="quiz-btn" class="tool-btn hidden" title="Generate Quiz Artifact">
                                <i data-lucide="book-open" size="18"></i>
                            </button>
                            <button id="summarize-btn" class="tool-btn hidden" title="Generate Summary Artifact">
                                <i data-lucide="align-left" size="18"></i>
                            </button>
                            
                            <!-- Document Badge -->
                            <div id="doc-info" class="hidden" style="display:flex; align-items:center; gap:8px; background:rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); padding:4px 10px; border-radius:8px; font-size:0.8rem; color:#e879f9; font-weight: 500;">
                                <i data-lucide="file" size="14"></i>
                                <span id="doc-name">source.pdf</span>
                                <button id="remove-doc-btn" style="background:none; border:none; color:inherit; font-size:1rem; cursor:pointer;" title="Remove">×</button>
                            </div>
                        </div>

                        <div style="display:flex; gap:12px; align-items:center;">
                            <!-- Stop Button -->
                            <button id="stop-btn" class="tool-btn hidden" title="Stop Execution">
                                <i data-lucide="square" size="16" style="fill: #ef4444; color: #ef4444;"></i>
                            </button>
                            <!-- Send Button -->
                            <button id="ask-btn" class="send-btn" disabled title="Run (⌘↵)">
                                <span>Run</span>
                                <i data-lucide="arrow-right" size="16"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- ==== RIGHT INSIGHT PANEL ==== -->
        <button id="insight-collapse-btn" class="toggle-btn app-floating-toggle app-right-toggle collapsed" title="Expand Panel (⌘⇧R)">
            <i data-lucide="chevron-right" size="16"></i>
        </button>

        <aside class="insight-panel hidden-mobile collapsed" id="insight-panel">
            <div class="insight-header" style="justify-content: center;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <i data-lucide="lightbulb" size="18" style="color: #a855f7;"></i> 
                    <span class="insight-title">Research Context</span>
                </div>
            </div>
            <div class="insight-content">
                
                <!-- Contextual Suggestions -->
                <div class="insight-section" id="context-suggestions">
                    <h4>Smart Actions</h4>
                    <div class="quick-tools">
                        <button class="q-tool-btn" onclick="document.getElementById('query-input').value='Provide a comprehensive technical summary of this workspace.'; if(!document.getElementById('ask-btn').disabled) document.getElementById('ask-btn').click();"><i data-lucide="align-left" size="16"></i> <span>Summarize Workspace</span></button>
                    </div>
                </div>

                <!-- Productivity Shortcuts -->
                <div class="insight-section">
                    <h4>Keyboard Shortcuts</h4>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div class="shortcut-item" title="Open Command Palette">
                            <span>Command Palette</span>
                            <div class="key-group"><span class="key-badge sys-mod">⌘</span><span class="key-badge">K</span></div>
                        </div>
                        <div class="shortcut-item" title="Execute Query">
                            <span>Run Query</span>
                            <div class="key-group"><span class="key-badge sys-mod">⌘</span><span class="key-badge">↵</span></div>
                        </div>
                        <div class="shortcut-item" title="Toggle Sidebar">
                            <span>Toggle Sidebar</span>
                            <div class="key-group"><span class="key-badge sys-mod">⌘</span><span class="key-badge">B</span></div>
                        </div>
                        <div class="shortcut-item" title="Toggle Focus Mode">
                            <span>Focus Mode</span>
                            <div class="key-group"><span class="key-badge sys-mod">⌘</span><span class="key-badge">\</span></div>
                        </div>
                    </div>
                </div>

                <!-- Web OS Changelog -->
                <div class="insight-section changelog-container">
                    <div class="insight-section-toggle" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="document.getElementById('changelog-body').classList.toggle('hidden');">
                        <h4>What's New</h4>
                        <i data-lucide="chevron-down" size="14" style="color:#64748b;"></i>
                    </div>
                    <div id="changelog-body" style="display:flex; flex-direction:column; margin-top:12px;">
                        <div class="changelog-item" onclick="openChangelogModal('v1.2.0 Productivity OS', 'New command palette, hover action bars, and streaming cursor optimizations. These updates drastically improve the power-user workflow by placing actions at your fingertips. Now you can hit ⌘K to open the palette and jump anywhere.', true)">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                                <span class="version-badge">v1.2.0</span>
                                <span style="font-size:0.8rem; color:#f8fafc; font-weight:500;">Productivity OS</span>
                            </div>
                            <p class="changelog-desc">New command palette, hover action bars, and streaming cursor optimizations.</p>
                        </div>
                        <div class="changelog-item" style="opacity: 0.6;" onclick="openChangelogModal('v1.1.5 Glass UI', 'Complete visual overhaul of research cards and workspace panels. We introduced deep blurs, intelligent hover states, and dynamic typography to make the reading experience incredibly immersive.', false)">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                                <span class="version-badge" style="background:rgba(255,255,255,0.1); color:#cbd5e1;">v1.1.5</span>
                                <span style="font-size:0.8rem; color:#f8fafc; font-weight:500;">Glass UI</span>
                            </div>
                            <p class="changelog-desc">Complete visual overhaul of research cards and workspace panels.</p>
                        </div>
                    </div>
                </div>
                
            </div>
        </aside>
    </div>

    <!-- Floating Context Menu -->
    <div id="selection-toolbar" style="display:none; position:fixed; z-index:300; background:rgba(3,7,18,0.9); backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.15); padding:6px; border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,0.5); gap:4px; transform:translate(-50%, -120%);">
        <button class="sel-action-btn" data-action="explain" style="background:none; border:none; color:#cbd5e1; cursor:pointer; border-radius:6px; padding:6px 10px; display:flex; align-items:center; gap:6px; font-size:0.8rem; transition:all 0.2s;"><i data-lucide="book-open" size="14"></i> Explain Deeper</button>
        <button class="sel-action-btn" data-action="simplify" style="background:none; border:none; color:#cbd5e1; cursor:pointer; border-radius:6px; padding:6px 10px; display:flex; align-items:center; gap:6px; font-size:0.8rem; transition:all 0.2s;"><i data-lucide="zap" size="14"></i> Simplify</button>
        <button class="sel-action-btn" data-action="copy" style="background:none; border:none; color:#cbd5e1; cursor:pointer; border-radius:6px; padding:6px 10px; display:flex; align-items:center; gap:6px; font-size:0.8rem; transition:all 0.2s;"><i data-lucide="copy" size="14"></i> Copy</button>
        <style> .sel-action-btn:hover { background: rgba(255,255,255,0.1); color: #fff !important; } </style>
    </div>

    <!-- Command Palette Modal -->
    <div id="cmd-palette" style="display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); align-items:flex-start; justify-content:center; padding-top: 15vh;">
        <div class="cmd-content" style="background:rgba(15,23,42,0.95); border:1px solid rgba(255,255,255,0.15); border-radius:16px; width:600px; max-width:90%; box-shadow: 0 24px 48px rgba(0,0,0,0.6); display:flex; flex-direction:column; overflow:hidden;">
            <div style="padding: 16px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); display:flex; align-items:center; gap: 12px;">
                <i data-lucide="search" size="18" style="color: #64748b;"></i>
                <input type="text" id="cmd-input" placeholder="Search commands... (e.g. New Session, Settings)" style="background:transparent; border:none; outline:none; color:#fff; font-size:1.1rem; width:100%; font-family:inherit;">
                <span style="font-size:0.7rem; color:#64748b; border: 1px solid rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">ESC</span>
            </div>
            <div class="cmd-results" style="padding: 8px 0; max-height: 300px; overflow-y: auto;">
                <div class="cmd-item" data-action="new-session" style="padding: 12px 24px; display:flex; align-items:center; gap: 12px; cursor:pointer; color: #cbd5e1; transition:all 0.2s;"><i data-lucide="plus" size="16"></i> New Session <span style="margin-left:auto; font-size:0.7rem; color:#64748b;">⇧⌘N</span></div>
                <div class="cmd-item" data-action="upload-doc" style="padding: 12px 24px; display:flex; align-items:center; gap: 12px; cursor:pointer; color: #cbd5e1; transition:all 0.2s;"><i data-lucide="upload-cloud" size="16"></i> Upload Document</div>
                <div class="cmd-item" data-action="generate-quiz" style="padding: 12px 24px; display:flex; align-items:center; gap: 12px; cursor:pointer; color: #cbd5e1; transition:all 0.2s;"><i data-lucide="brain" size="16"></i> Generate Quiz from Context</div>
                <div class="cmd-item" data-action="toggle-focus" style="padding: 12px 24px; display:flex; align-items:center; gap: 12px; cursor:pointer; color: #cbd5e1; transition:all 0.2s;"><i data-lucide="maximize" size="16"></i> Toggle Focus Mode <span style="margin-left:auto; font-size:0.7rem; color:#64748b;">⌘\</span></div>
            </div>
            <style> .cmd-item:hover, .cmd-item.active { background: rgba(168, 85, 247, 0.15); color: #fff !important; } </style>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" style="display:none; position:fixed; inset:0; z-index:400; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); align-items:center; justify-content:center; padding: 20px;">
        <div class="cmd-content" style="background:rgba(15,23,42,0.95); border:1px solid rgba(255,255,255,0.15); border-radius:16px; width:450px; max-width:100%; box-shadow: 0 24px 48px rgba(0,0,0,0.6); display:flex; flex-direction:column; overflow:hidden; position:relative;">
            <button onclick="document.getElementById('changelog-modal').style.display='none';" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.05); border:none; border-radius:8px; color:#94a3b8; cursor:pointer; padding:6px; display:flex;"><i data-lucide="x" size="16"></i></button>
            <div style="padding: 24px 24px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap: 12px;">
                <div style="width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg, #a855f7 0%, #6366f1 100%); display:flex; align-items:center; justify-content:center; color:white; box-shadow:0 4px 12px rgba(168,85,247,0.3);"><i data-lucide="sparkles" size="18"></i></div>
                <h3 style="margin:0; font-size:1.1rem; color:#fff; letter-spacing:0.5px;">Workspace Updates</h3>
            </div>
            <div id="changelog-modal-body" style="padding: 24px; max-height: 60vh; overflow-y: auto;">
                <!-- Filled dynamically via JS -->
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal (Retained logic) -->
    <div id="custom-modal" class="modal-overlay hidden" style="position:fixed; inset:0; z-index:100; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:rgba(15,23,42,0.9); border:1px solid rgba(255,255,255,0.1); padding:24px; border-radius:16px; width:400px; max-width:90%;">
            <h3 id="modal-title" style="margin-top:0;">Confirm Action</h3>
            <p id="modal-message" style="color:#94a3b8;">Are you sure you want to proceed?</p>
            <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
                <button id="modal-cancel" style="background:none; border:1px solid rgba(255,255,255,0.1); color:#fff; padding:8px 16px; border-radius:8px; cursor:pointer;">Cancel</button>
                <button id="modal-confirm" style="background:#ef4444; border:none; color:#fff; padding:8px 16px; border-radius:8px; cursor:pointer;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Core App Logic -->
    <script>
        // Platform specific shortcut modifier mapping
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        if (!isMac) {
            document.querySelectorAll('.sys-mod').forEach(el => el.textContent = 'Ctrl');
            const qc = document.getElementById('query-input');
            if (qc) qc.placeholder = qc.placeholder.replace(/⌘/g, 'Ctrl+');
            document.querySelectorAll('[title]').forEach(t => { t.title = t.title.replace(/⌘/g, 'Ctrl+'); });
        }

        // Changelog Modal
        function openChangelogModal(title, desc, hasAction) {
            const modal = document.getElementById('changelog-modal');
            const body = document.getElementById('changelog-modal-body');
            const btnKey = isMac ? '⌘K' : 'Ctrl+K';
            
            const actionHtml = hasAction ? `<button style="margin-top:24px; background:linear-gradient(135deg, #a855f7 0%, #6366f1 100%); color:white; border:none; padding:10px 18px; border-radius:10px; font-weight:600; cursor:pointer; display:flex; gap:8px; align-items:center; box-shadow:0 4px 16px rgba(168,85,247,0.4); transition:all 0.2s;" onclick="var ev = new KeyboardEvent('keydown', {metaKey:true, ctrlKey:!isMac, key:'k'}); window.dispatchEvent(ev); document.getElementById('changelog-modal').style.display='none';" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'"><i data-lucide="zap" size="16"></i> Try Feature (${btnKey})</button>` : '';
            
            body.innerHTML = `
                <h4 style="margin:0 0 12px 0; color:#e2e8f0; font-size:1.1rem;">${title}</h4>
                <p style="margin:0; color:#94a3b8; font-size:0.95rem; line-height:1.6;">${desc}</p>
                ${actionHtml}
            `;
            lucide.createIcons();
            modal.style.display = 'flex';
        }

        lucide.createIcons();
        
        // Workspace Collapse Logic
        const sidebarEl = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebar-collapse-btn');
        sidebarToggleBtn.addEventListener('click', () => {
            sidebarEl.classList.toggle('collapsed');
            sidebarToggleBtn.classList.toggle('collapsed');
            const isColl = sidebarEl.classList.contains('collapsed');
            sidebarToggleBtn.title = isColl ? "Expand Sidebar" : "Collapse Sidebar";
        });

        const insightPanel = document.getElementById('insight-panel');
        const insightToggleBtn = document.getElementById('insight-collapse-btn');
        insightToggleBtn.addEventListener('click', () => {
            insightPanel.classList.toggle('collapsed');
            insightToggleBtn.classList.toggle('collapsed');
            const isColl = insightPanel.classList.contains('collapsed');
            insightToggleBtn.title = isColl ? "Expand Panel" : "Collapse Panel";
        });
    </script>
    <script src="./frontend/scripts/main.js?v=6"></script>
</body>
</html>
